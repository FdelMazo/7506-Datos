\documentclass[a4paper]{article}

\usepackage[utf8]{inputenc}
\usepackage[spanish]{babel}
\usepackage{float}
\usepackage{fancyhdr,graphicx,listings,amsmath,tocloft}
\usepackage[colorlinks=true,linkcolor=black,urlcolor=blue,bookmarksopen=true]{hyperref}

\newcommand{\materia}{[75.06 / 95.58] Organización de Datos}
\newcommand{\trabajo}{Trabajo Práctico 2: Machine Learning}
\newcommand{\trabajoheader}{TP2}
\newcommand{\cuatri}{2c2018}
\newcommand{\cuatrimestre}{Segundo cuatrimestre de 2018}
\newcommand{\grupo}{Grupo Datatouille}
\newcommand{\repo}{https://github.com/FdelMazo/7506-Datos/}
\newcommand{\kernel}{https://kaggle.com/datatouille2018/}
\newcommand{\alumnos}{
    Bojman, Camila & 101055 &  camiboj@gmail.com\\
    del Mazo, Federico & 100029 & delmazofederico@gmail.com\\
    Hortas, Cecilia & 100687 & ceci.hortas@gmail.com\\
    Souto, Rodrigo & 97649 & rnsoutob@gmail.com\\
}
\newcommand{\curso}{Curso 01}
\newcommand{\docentes}{
    \item Argerich, Luis Argerich
    \item Golmar, Natalia
    \item Martinelli, Damina Ariel
    \item Ramos Mejia, Martín Gabriel
}

\hypersetup{
    pdftitle={\trabajo},
	pdfsubject={\materia},
	pdfauthor={\grupo},
}

\setlength{\cftbeforesecskip}{6pt}

\pagestyle{fancy}
\fancyhf{}
\fancyhead[L]{\materia}
\fancyhead[R]{\trabajoheader - \cuatri}
\renewcommand{\headrulewidth}{0.4pt}
\fancyfoot[C]{\thepage}
\renewcommand{\footrulewidth}{0.4pt}

\begin{document}
\pagenumbering{gobble}

\begin{titlepage}
	\hfill\includegraphics[width=6cm]{fiuba.jpg}
    \begin{center}
    \vfill
    \Huge \textbf{\trabajo}
    \vskip2cm
    \Large \materia\\
    \cuatrimestre
    \vfill
    \begin{flushleft} 
    \grupo
    \end{flushleft}
    \begin{tabular}{|l|c|r|}
	\hline
	Alumno & Padrón & Mail\\
	\hline \hline
    \alumnos
	\hline
	\end{tabular}
    \begin{flushleft} 
    \large{\url{\repo}} \\
    \large{\url{\kernel}} \\
    \end{flushleft}
    \vskip1cm
    \end{center}
    \curso
    \begin{itemize}
        \docentes
    \end{itemize}
\end{titlepage}
\pagenumbering{roman}
\tableofcontents
\newpage
\pagenumbering{arabic}
\setcounter{page}{1}

\section{Introducción}

Se propone exponer en el siguiente informe el desarrollo del Trabajo Práctico para predecir la probabilidad de que un usuario de Trocafone realice una conversión en un período determinado de tiempo. Con dicho propósito se utilizan como base dos archivos csv brindados por la empresa. En un primer lugar el archivo \texttt{events\_up\_to\_01062018.csv} que contiene la información de los eventos realizados por un conjunto de usuarios hasta el 31 de mayo de 2018. En un segundo lugar el archivo \texttt{labels\_training\_set.csv} que determina si un conjunto de usuarios realizó o no una conversión desde el 01/06/2018 hasta el 15/06/2018. 

Se propone como objetivo desarrollar una métrica a fin de evaluar los distintos resultados obtenidos. Se presentan en el informe las distintas decisiones adoptadas para elegir un resultado por sobre otro. Así mismo, se propuso utilizar distintos algoritmos de la librería sklearn para elegir el que modelice mejor. 

Por otro lado se crearon distintos csv a fin de poder desarrollar de mejor manera el proceso de feature engineering y obtener un pre-procesamiento de los datos que permita encontrar los resultados más altos. 

\section{Investigación}

Como se mencionó en la \textit{Introducción}, se realizó un proceso de exploración de los datos para crear nuevos atributos y extraer nuevos features. De esta manera se crearon distintos csv con información extraída tanto de internet como de los propios datos para luego concatenar al set de datos final. Se procede a dar una breve explicación de la funcionalidad de cada uno de ellos. Muchos de ellos se encuentran detallados en el 'Notebook Anexo' del TP1\footnote{https://fdelmazo.github.io/7506-Datos/TP1/TP1.html}.

\begin{itemize}
	\item brands.csv

Se agregó una columna al dataframe que detalla qué marca está involucarada en el evento del usuario.

	\item {os.csv}
	
Se agregó una columna al dataframe que detalla qué sistema operativo está involucarada en el evento del usuario.

	\item{browsers.csv}

Se agregó una columna al dataframe que detalla qué explorador de internet se accede al sitio.	

	\item{sessions.csv}

Se agregó el concepto de sesión, que se define como la agrupación de una serie de eventos por usuario, los cuales están todos con menos de 30 minutos de
inactividad entre el actual y el anterior. Esto fue fijado con un criterio arbitrario a fin de poder discretizar el tiempo y definir este concepto.

	\item{prices.csv}

Se agregó una columna al dataframe que indica el precio del producto involucrado en el evento del usuario. Para ello se extrajeron los precios de la página de Trocafone\footnote{https://www.trocafone.com/} considerando el sku, el modelo, el color, la capacidad de almacenamiento y la condición.
\end{itemize}

\section{Feature engineering}

A partir del nuevo dataframe obtenido con la unión de todos los csv descritos en el inciso anterior se procedió a la búsqueda de features. En esta étapa del desarrollo del Trabajo Práctico se buscó explotar las distintas ideas y después con un proceso de selección que será explicado maś adelante elegir los features pertinentes y más útiles al modelo. 

\subsection{Features básicos}
Se detallan los features generales considerados como pertinentes al modelo.

\begin{itemize}
	\item is\_viewed\_product: el usuario vió un producto
	\item is\_checkout: el usuario llegó a checkout con un producto
	\item is\_conversion: el usuario compró un producto
	\item session\_checkout\_first: el usuario en su primera sesión realizó un checkout
	\item session\_conversion\_first: el usuario en su primera sesión realizó una conversión
	\item session\_ad\_first: el usuario en su primera sesión llegó con una campaña publicitaria
	\item session\_ad\_checkout\_event: el usuario en su primera sesión llegó con una campaña publicitaria e hizo checkout
	\item session\_ad\_conversion\_event: el usuario en su primera sesión llegó con una campaña publicitaria y compró el producto	
\end{itemize}	
	
\subsection{Suma total de eventos}

A los features agregados como \textit{features básicos} se le calcula el total por usuario y se obtienen el siguiente listado de features:
\begin{itemize}
	\item total\_viewed\_products: cantidad de productos que vio el usuario en el período de tiempo determinado.
	\item total\_checkouts: cantidad de veces que el usuario hizo checkout en el período de tiempo determinado.
	\item total\_conversions: cantidad de compras que realizó el usuario en el período de tiempo determinado.
	\item total\_events: cantidad de eventos totales que el usuario hizo en el período de tiempo determinado.
	\item total\_sessions: cantidad total de sesiones del usuario
	\item total\_session\_checkout: cantidad total de sesiones donde el usuario hizo checkout
	\item total\_session\_conversion: cantidad total de sesiones donde el usuario convirtió.
	\item total\_events\_ad\_session: cantidad total de sesiones donde el usuario ingresó por una campaña publicitaria.
	\item total\_ad\_sessions: cantidad total de sesiones donde el usuario ingresó por primera vez por una campaña publicitaria.
\end{itemize}
	
A partir de estos features se deducen los siguientes:

\begin{itemize}
	\item avg\_events\_per\_session: porcentaje de cantidad total de eventos sobre cantidad de sesiones
	\item avg\_events\_per\_ad\_session: porcentaje de cantidad total de eventos donde el usuario ingresó por una campaña publicitaria sobre cantidad total de sesiones donde el usuario ingresó por una campaña publicitaria
	\item percentage\_session\_ad: porcentaje de cantidad total de sesiones donde el usuario ingresó por primera vez por una campaña publicitaria sobre el total de sesiones
	\item percentage\_session\_conversion: porcentaje de cantidad total de sesiones donde el usuario ingresó por primera vez y compró sobre la cantidad total de sesiones
	
\end{itemize}

\subsection{Cantidad de eventos por mes}

Se agregan una serie de features relacionados a la cantidad de eventos y sesiones por mes que se consideraron pertinentes al modelo.

\begin{itemize}
	\item total\_viewed\_products\_month: cantidad de productos vistos por mes por usuario
	\item total\_checkouts\_month: cantidad de productos que llegaron a checkout por mes por usuario
	\item total\_conversions\_month: cantidad de productos que llegaron a ser comprados por mes por usuario
	\item total\_events\_month: cantidad de eventos por mes por usuario
	\item total\_sessions\_month\_: cantidad total de sesiones por mes
	\item total\_session\_checkouts\_month\_: cantidad total de sesiones donde el usuario hace checkout por mes
	\item total\_session\_conversions\_month\_: cantidad total de sesiones donde el usuario compra un producto por mes
	\item total\_events\_ad\_session\_month\_: cantidad total de sesiones donde el usuario ingresa a la página por una campaña publicitaria por mes
	\item total\_ad\_sessions\_month\_: cantidad total de sesiones donde el usuario ingresa a la página por primera vez por una campaña publicitaria por mes
	 
\end{itemize}

\subsection{Eventos sin contar mayo}

\subsection{Eventos en última semana}

\subsection{Distribución mensual de las conversiones}

Se agrega en cuántos meses el usuario compró suponiendo que dicha distribución denota si el usuario es un comprador habitual o sólo compró alguna vez aisladamente. El feature se llama "amount\_of\_months\_that\_have\_bought".

\subsection{Informacion de los últimos eventos registrados por usuario}

Se busca extraer información de los días que transcurrieron hasta el último evento de un usuario. De esta manera se espera que el modelo aprenda un factor importante para la predicción. Por ejemplo, si un usuario vio un producto hace muchos días es muy probable que no lo compre pero si hizo checkout hace 1 dia es probable que en un futuro cercano compre.

\begin{itemize}
	\item days\_to\_last\_event: cantidad de días hasta el último evento
	\item days\_to\_last\_checkout: cantidad de días hasta el último checkout. Si el usuario no hizo checkout se considera un número mayor a la cantidad de días del período de tiempo comprendido.
	\item days\_to\_last\_conversion: cantidad de días hasta la última compra del usuario. Si el usuario nunca compró se considera un número mayor a la cantidad de días del período de tiempo comprendido.
	\item days\_to\_last\_viewed\_product: cantidad de días hasta el último día que el usuario vio un producto. Si el usuario nunca vio un producto se considera un número mayor a la cantidad de días del período de tiempo comprendido.
\end{itemize}
	
En paralelo con estos features se consideran los días de la semana, del mes, del año y la semana del año donde ocurren estos últimos eventos.	
	
\subsection{Precios de la ultima conversion realizada por el usuario}

Se consideró que podría considerarse el precio de la última conversión del usuario como un feature pero a la hora de la selección reflejó una importancia muy baja. Por lo tanto consideramos impertinente la descripción de la idea que habíamos pensado desarrollar.

\subsection{Porcentaje de la actividad de la ultima semana}

Aquí la idea pensada era reflejar la cantidad de eventos del usuario de la última semana sobre el total. Si el usuario ingresó muchas veces a la página en la última semana de mayo es muy probable que compre en la primera semana de junio. De la misma manera, si el usuario compró la última semana de mayo es probable que no compre por las siguientes dos.

Por lo tanto se pensaron los siguientes features:

\begin{itemize}
	\item percentage\_last\_week\_activity: porcentaje de la cantidad de eventos de esa semana sobre el total de eventos
	\item percentage\_last\_week\_conversions:  porcentaje de la cantidad de compras de esa semana sobre el total de eventos
	\item percentage\_last\_week\_checkouts: porcentaje de la cantidad de checkouts de esa semana sobre el total de eventos
	\item percentage\_last\_week\_viewed\_products: porcentaje de la cantidad de productos vistos de esa semana sobre el total de eventos
\end{itemize}


\subsection{Porcentaje de la actividad del ultimo mes}
Una lógica análoga a la sección pecedente se sigue en esta parte. Los motivos de este feature son simplemente una apliación de la idea anterior. Si el usuario ingresó muchas veces a la página en mayo es muy probable que compre en la primera semana de junio. De la misma manera, si el usuario compró en mayo es algo probable que no compre por las siguientes dos.

De más está decir que se pensaron los siguientes features:
\begin{itemize}
	\item percentage\_last\_month\_activity: porcentaje de la cantidad de eventos de ese mes sobre el total de eventos
	\item percentage\_last\_month\_conversions:  porcentaje de la cantidad de compras de ese mes sobre el total de eventos
	\item percentage\_last\_month\_checkouts: porcentaje de la cantidad de checkouts de ese mes sobre el total de eventos
	\item percentage\_last\_month\_viewed\_products: porcentaje de la cantidad de productos vistos de ese mes sobre el total de eventos
\end{itemize}

\subsection{Días entre el último checkout y última actividad}
La intención de este feature es medir la diferencia de días que tiene cada usuario entre la compra de un celular y la ultima vez que visualizo el producto comprado. De esta forma poder predecir en base a los productos vistos si es posbile que se haga una compra.

\subsection{Estados de celulares}
Utilizando la lógica de que hay empresas que compran celulares en mal estado con el único fin de usar sus partes como respuestos se plantea agregar una columna que indique porcentaje de celulares en estado Bom - Sem Touch ID vs Bom sobre todos los celulares vistos.

\subsection{Varianza logarítmica de productos vistos}
Lo que se plantea es analizar la varianza en los precios de los productos visitados. Es decir, si los usuarios ven telefonos de un rango pequeño de precio o, por el contrario, articulos de precios muy variados. Se utilizó una escala logarítmica para seguir manteniendo las proporciones sin tener una gran diferencia entre la varianza de un usuario y la de otro.
\subsection{¿El usuario compró más de la media?}

\subsection{¿Cuántas veces vio el último modelo que compró?}

\subsection{¿Cuantas veces vio la última marca que compró?}

\subsection{Comportamiento en sesiones de las últimas semanas}

\section{Algoritmos utilizados}

\section{Desarrollo}
Para el desarrollo del Trabajo se utilizaron una serie de notebooks que buscaron organizar de la manera más clara posible los distintos pasos a realizar para desarrollar un submit. Se describen los distintos notebooks que fueron utilizados:
\begin{enumerate} 
\item new\_dataframes 	

En este notebook se crearon los distintos csv que fueron realizados para la extracción de features, como fue mencionado anteriormente. 

\item feature\_engineering

En este notebook se agregan todos los features que se consideran que pueden ser pertinentes para el modelo. Para esto mismo se pensó agregar todos los features que se consideren que pueden ser útiles pero sabiendo que luego se somete a un proceso de selección. 

\item feature\_selection

En este notebook se utilizan distintas formas de seleccionar los features de manera de eliminar aquellos atributos que resulten ruidosos con el modelo de \texttt{Random Forest}. Se eligió dicho modelo por su popularidad para la selección de features ya que los árboles que crea el algoritmo toman distintos subconjuntos de atributos tomados al azar y arrojan distintos resultados. De esta manera, con cientos o miles de árboles el algoritmo adopta una amplia capacidad predictora de cada atributo.

Se utiliza como métrica el AUC debido a que es la utilizada por la plataforma de Kaggle para evaluar la eficiencia de los distintos modelos utilizados. 

Las distintas formas de selección utilizadas se describen como sigue:

\begin {itemize}
\item \textbf{Cumulative importance}

El nombre del método fue inventado por el grupo de Trabajo y denota el método más intuitivo para la selección de features. Con el uso del algoritmo de \texttt{Random Forest} se parte de una lista de todos los features ordenados según importancia y se genera una lista de listas que agrega un feature a la vez. Por ejemplo siendo a,b,c features se parte de una lista como [a,b,c] y luego se obtiene  [ [a], [a,b], [a,b,c] ]. El objetivo de este método es encontrar el 
\textit{codo}, es decir, los features que incrementan el AUC local.

\item \textbf{Forward Selection}

Con este método se comienza con ningún atributo y en cada paso se agrega el atributo que genere mejor resultado. Se agregan atributos siempre y cuando los resultados mejoren. El algoritmo termina cuando el resultado no se puede mejorar o cuando ya se han agregado todos los atributos.

\item \textbf{Backward Selection}

Este método funciona a la inversa de \texttt{Forward Selection}. Se comienza con todos los atributos y se quita en cada iteración el atributo que aumente el resultado de la métrica. De esta manera el algoritmo termina cuando al quitar un atributo el resultado empeora o cuando ya no hay más atributos por quitar.

\item \textbf{Stepwise Selection}

Este método es una variante que combina los dos métodos anteriores. En cada paso se considera agregar o quitar una variable de manera de aumentar el AUC local.	

\end {itemize}

\end{enumerate}

 

\section{Resultados obtenidos}

\section{Conclusiones}

\end{document}